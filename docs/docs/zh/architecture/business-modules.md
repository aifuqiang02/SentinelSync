# 业务模块规划

基于 AI 驱动的集中化运维平台定位，SentinelSync 规划了以下五大核心业务模块：

## 模块一：智能数据备份管理

**核心功能：**

- **实时监控与捕获**：基于 fsnotify 的文件系统变更检测
- **智能哈希计算**：异步队列处理，流式计算避免内存峰值
- **断点续传**：传输任务持久化，支持网络中断恢复
- **备份策略管理**：全量/增量/差异备份配置
- **备份验证**：完整性校验与一致性检查

**技术实现：**
- Agent 端：Go fsmonitor + backup_logic
- 服务端：Go Hasher + Transporter 服务
- 存储：PostgreSQL (file_metadata)

**业务价值：** 保障数据零丢失，备份过程对业务无感知

---

## 模块二：全生命周期资产管理

**核心功能：**

- **自动发现与注册**：Agent 上线自动注册到资产库
- **实时监控**：CPU、内存、磁盘、网络等基础指标
- **版本跟踪**：操作系统、Agent 版本、关键组件版本管理
- **状态管理**：在线/离线、健康状态、最后一次心跳时间
- **资产配置**：动态配置下发与同步

**技术实现：**
- Agent 端：定期心跳上报
- 服务端：Python API + PostgreSQL (agent_assets, agent_config)
- 前端：Vue 3 资产列表与详情页

**业务价值：** 全局资产可视化，快速定位问题节点

---

## 模块三：远程运维指挥中心

**核心功能：**

- **命令下发**：通过 Web UI 触发远程操作（立即备份、服务重启等）
- **批量操作**：对多节点执行相同命令
- **执行记录**：所有操作审计日志
- **实时反馈**：命令执行状态实时推送（WebSocket）

**技术实现：**
- 前端：Vue UI 组件
- API：Python FastAPI
- 消息流：RabbitMQ control_commands → Go Agent Remote Executor
- 实时通信：WebSocket 双向通信

**业务价值：** 提升运维效率，降低人工登入成本

---

## 模块四：集中日志智能分析

**核心功能：**

- **实时采集**：Agent 端系统日志、应用日志、错误日志
- **统一存储**：结构化存储到 PostgreSQL
- **日志检索**：多条件组合搜索（时间范围、级别、来源）
- **智能告警**：基于规则的异常检测

**技术实现：**
- Agent 端：日志事件生成 → RabbitMQ(log_events)
- 服务端：Go Log Processor → PostgreSQL(system_logs)
- 查询：Python API 提供检索接口
- 可视化：Vue 日志查看器

**业务价值：** 全系统可观测性，快速故障定位

---

## 模块五：AI 驱动的预测性运维

**核心功能：**

- **异常检测**：基于历史数据和实时数据流，通过机器学习模型（如结合 LSTM 的时间序列预测模型，或基于聚类的离群点检测）自动识别系统异常模式（如备份失败、CPU 或内存使用率异常波动、网络延迟突增等）。
- **性能预测**：利用历史性能指标数据，通过预测模型（如 ARMA、Prophet）预测磁盘使用率、备份时长、网络带宽需求等趋势，提前预警潜在瓶颈。
- **容量规划与优化**：结合性能预测和历史资源使用情况，智能分析和推荐资源扩容方案，如数据库存储空间、计算资源等。同时，提供Agent端任务并发数、备份窗口优化建议，提高资源利用率。
- **智能根因分析**：关联分析多源异构数据（日志、指标、事件），通过图神经网络或因果推断模型自动分析故障事件之间的关联性，快速定位问题的根本原因。
- **自动化优化建议**：基于 AI 分析结果，提供可操作的优化建议，例如调整备份频率、优化SQL查询、推荐资源配置参数等，辅助运维人员制定决策。
- **安全事件预测与分析**：通过分析日志和网络流量数据中的异常模式和上下文信息，预测潜在的网络攻击或未授权访问，提升安全防护能力。
- **智能调度与负载均衡**：结合 Agent 负载、资源使用率和任务优先级，智能调度备份或远程执行任务，实现更优的负载均衡和资源分配。

**技术实现：**
- Python ML 模块：Pandas/Scikit-learn/TensorFlow/PyTorch
- 数据源：PostgreSQL(ai_insights, file_metadata, system_logs)
- 训练引擎：周期性训练与模型更新
- 推理服务：FastAPI 端点实时推理

**业务价值：** 从被动响应转向主动预防，降低故障率

---

## 业务模块交互关系图

```
┌──────────────────────────────────────────────────┐
│          Web UI 仪表盘 (Vue 3)                   │
└──────────────┬─────────────────┬─────────────────┘
               │                 │
        ───────┴───────           │
        │★ 资产管理   │           │
        └───────┬──────┘           │
                │                  │
        ────────┴──────            │
        │★ 智能备份   │           │
        └───────┬──────┘           │
                │                  │
        ────────┴──────            │
        │★ 远程运维   ←─────────┼──────── Web UI
        └───────┬──────┘           │
                │                  │
        ────────┴──────            │
        │★ 集中日志   │           │
        └───────┬──────┘           │
                │                  │
        ────────┴──────            │
        │★ AI 分析   │           │
        └──────────────┘           │
                                   │
        ────────────────────────────────
        │ Python FastAPI + ML 引擎        │
        │ PostgreSQL + RabbitMQ           │
        ────────────────────────────────
                                   │
                       ┌───────────┼───────────┐
                       ▼           ▼           ▼
                ┌──────────┐ ┌──────────┐ ┌──────────┐
                │Go Agent 1│ │Go Agent 2│ │Go Agent n│
                └──────────┘ └──────────┘ └──────────┘
```

**交互说明：**
* **Web UI (Vue 3)** 通过 RESTful API 和 WebSocket 与 **Python FastAPI (管理服务器)** 进行交互，实现资产管理、远程运维命令触发、日志查询和 AI 洞察展示等。
* **Python FastAPI (管理服务器)** 是核心业务逻辑层，它：
    * 负责资产和配置的持久化 (PostgreSQL `agent_assets`, `agent_config`)。
    * 将远程控制命令发送到 **RabbitMQ** 的 `control_commands` 队列，由 Go Agent 的 `remote_executor` 模块消费。
    * 通过 Go Agent 的心跳上报数据，更新资产状态。
    * 提供日志检索接口，从 **PostgreSQL** 的 `system_logs` 表中获取数据。
    * 运行 **ML Engine** 进行 AI 分析，并将结果存储到 `ai_insights` 表，或从 `file_metadata`, `system_logs` 等表获取数据进行分析。
* **Go Agent** 部署在目标机器上，是平台的数据采集和执行单元：
    * `fsmonitor` 和 `backup_logic` 模块负责文件系统监控和备份，生成 `metadata.change` 事件发布到 **RabbitMQ** 的 `metadat-in` 队列。
    * `log_events` 生成日志事件并发布到 **RabbitMQ** 的 `log_events` 队列。
    * `remote_executor` 模块消费 **RabbitMQ** `control_commands` 队列中的远程控制命令。
    * 定期心跳上报资产信息给 **Python FastAPI**。
* **Go 服务 (Hasher, Transporter, Log Processor)** 是 RabbitMQ 消息的消费者：
    * **Hasher 服务** 消费 `metadat-in` 队列，计算文件哈希，并将 `transfer.needed` 事件发布到 `transfer_out` 队列。
    * **Transporter 服务** 消费 `transfer_out` 队列，负责备份数据的传输。
    * **Log Processor 服务** 消费 `log_events` 队列，将日志事件写入 **PostgreSQL** 的 `system_logs` 表。
* **RabbitMQ** 作为高效的消息中间件，连接了 Go Agent、Go 服务和 Python FastAPI，实现异步通信和解耦。
* **PostgreSQL** 作为核心数据存储，管理了文件元数据、资产信息、配置、系统日志和 AI 洞察结果等。

每个模块都有清晰的：
- **核心功能**：解决具体业务问题
- **技术实现**：对应的技术栈和组件
- **业务价值**：为运维团队带来的具体收益

这种模块化设计使得系统可以同时满足：
✅ **实时性**：文件变更秒级响应
✅ **可靠性**：异步队列 + 持久化存储
✅ **智能化**：AI 驱动的预测分析
✅ **可扩展性**：微服务架构，水平扩展


## 错误处理和容错机制

为了确保平台的稳定性和数据的可靠性，SentinelSync 在设计时充分考虑了错误处理和容错机制：

*   **消息队列的持久化与重试**：RabbitMQ 的消息被设置为持久化，确保在消息代理崩溃时消息不丢失。同时，消费者服务会实现消息确认机制和重试策略，对于处理失败的消息能够进行重试或进入死信队列，避免消息丢失。
*   **Agent 断线重连**：Go Agent 设计有自动断线重连机制，当与 Control Plane (Python FastAPI, RabbitMQ) 的连接中断时，能够自动尝试重新建立连接，确保长时间运行的稳定性。
*   **传输任务断点续传**：数据备份传输支持断点续传，在网络中断或其他异常导致传输中断后，服务能够从上次成功传输的位置继续传输，避免重复工作和数据不一致。
*   **数据一致性校验**：备份数据在传输后会进行完整性校验（例如，通过哈希值比对），确保数据在传输过程中没有被损坏或篡改。
*   **服务降级与限流**：在系统负载过高或部分服务出现故障时，可以通过服务降级和限流机制，保护核心服务不受影响，保证系统基本可用性。
*   **可观测性**：通过集中日志、指标监控和 **分布式追踪**，提供 **Metrics 收集**，从多维度实时发现和定位问题，为故障排查提供数据支持。例如：
    *   **集中日志 (Logging)**：Go Agent 和所有服务产生的日志统一收集到 PostgreSQL，便于集中检索分析。
    *   **指标监控 (Metrics)**：通过 Prometheus/Grafana 栈或类似工具，收集并展示 Agent、服务和系统资源的关键性能指标。
    *   **分布式追踪 (Tracing)**：集成 OpenTracing/OpenTelemetry 兼容的追踪系统（如 Jaeger），实现跨服务的请求链路追踪，帮助快速定位分布式环境下的性能瓶颈和故障。

---

## 安全性考虑

作为一个运维平台，安全性是 SentinelSync 的基石。我们从多个层面保障平台和数据的安全：

*   **身份认证与权限管理**：
    *   **统一认证**：支持多种身份认证方式，如用户名/密码、OAuth2、LDAP集成等。
    *   **精细化权限控制**：基于角色的访问控制（RBAC），允许对不同用户组分配不同的资源访问和操作权限。
    *   **Agent 身份验证**：每个 Go Agent 在注册和与 Control Plane 通信时，都需要进行严格的身份验证。
*   **数据传输安全**：
    *   **端到端加密**：所有 Agent 与 Control Plane 之间、Web UI 与后端 API 之间的数据传输均采用 TLS/SSL 加密，防止数据窃听和篡改。
    *   **内部服务通信加密**：RabbitMQ 等内部组件之间的通信也应配置为加密连接。
*   **API 安全**：
    *   **输入验证**：所有 API 接口对传入参数进行严格的验证和过滤，防止注入攻击（SQL 注入、命令注入等）。
    *   **速率限制**：对 API 调用进行速率限制，防止拒绝服务攻击。
    *   **会话管理**：安全的会话管理机制，如使用 JWT（JSON Web Tokens），并定期刷新。
*   **操作审计**：
    *   **完整审计日志**：所有关键操作，特别是远程命令执行和配置修改，都会被记录完整的审计日志，包括操作者、时间、IP、操作内容和结果，便于安全溯源。
*   **最小权限原则**：
    *   **组件权限隔离**：各个微服务、数据库连接和 Agent 均采用最小权限原则，仅授予其完成工作所需的最低权限。
*   **漏洞管理**：
    *   **安全扫描**：定期对代码库和部署环境进行安全扫描，及时发现和修复已知漏洞。
    *   **依赖管理**：定期更新第三方库和组件，规避已知的软件供应链漏洞。

---



## 监控与告警实现

SentinelSync 平台将构建全面的监控和智能告警体系，确保及时发现、定位和响应潜在问题：

*   **多维度数据采集**：
    *   **Agent 端指标**：Go Agent 定期采集并上报主机的 CPU、内存、磁盘 I/O、网络流量等基础资源指标，以及 Agent 自身的运行状态（如进程健康、备份任务进度等）。
    *   **应用日志**：通过 Go Agent 实时采集系统日志、应用日志（包括错误日志、访问日志等），并结构化存储。
    *   **业务指标**：如备份成功率、传输吞吐量、API 响应时间等关键业务指标。
*   **统一数据存储与处理**：
    *   所有采集到的指标和日志数据将统一存储在 PostgreSQL 中，便于集中管理和查询。
    *   利用 Python FastAPI 提供的数据处理层进行数据聚合、清洗和标准化。
*   **灵活的告警规则配置**：
    *   **基于阈值告警**：支持配置静态阈值，如 CPU 使用率超过 80% 持续 5 分钟。
    *   **基于规则告警（日志）**：例如，在一定时间内出现特定数量的 ERROR 或 FATAL 级别日志。
    *   **基于 AI 智能告警**：结合 AI 驱动的预测性运维模块，识别异常模式，进行更智能的预测性告警（如预测磁盘空间即将耗尽、备份任务可能失败等）。
*   **多样化的告警通知**：
    *   支持通过邮件、短信、Webhook（集成到企业微信、钉钉等IM工具）等多种方式发送告警通知。
    *   告警信息包含详细的事件描述、影响范围、建议处理措施等，帮助运维人员快速响应。
*   **可视化告警管理**：
    *   前端 Vue UI 提供直观的告警仪表盘，展示告警事件的实时状态、历史趋势和处理记录。
    *   支持告警的确认、升级、静默和自定义处理流程。

---



## 配置管理

SentinelSync 平台需要管理 Agent 和各项服务的配置，以支持动态调整和灵活部署：

*   **集中化配置存储**：
    *   所有可动态配置的参数（例如，Agent 上报频率、备份策略、告警规则等）将集中存储在 PostgreSQL 的 `agent_config` 表中。
*   **动态配置下发**：
    *   **Python API 接口**：管理服务器提供 API 接口，允许运维人员通过 Web UI 或其他工具修改配置。
    *   **RabbitMQ + Agent 拉取**：配置变更通过 RabbitMQ 向相关的 Agent 推送通知，Agent 在收到通知后主动从管理服务器拉取最新配置。这样可以避免实时推带来的复杂性，并允许 Agent 在网络中断后也能恢复最新配置。
*   **配置版本管理**：
    *   `agent_config` 表中的配置数据应支持版本控制，记录每次配置修改的历史，方便回溯和审计。
*   **配置的生效与验证**：
    *   配置下发后，Agent 内部模块会重新加载并验证新配置，确保其有效性。无效配置将被拒绝，并上报错误信息。
*   **配置文件与环境变量**：
    *   对于启动时加载的静态配置（如数据库连接字符串、RabbitMQ 地址），主要通过环境变量或本地配置文件（如 `config.yml`）管理，并支持 Docker 容器化的配置管理。

---



## 扩展性规划

SentinelSync 平台从设计之初就考虑了系统的可扩展性，以应对未来业务增长和功能扩展的需求：

*   **微服务架构**：
    *   平台采用微服务架构，各个模块（Agent、Hasher、Transporter、Log Processor、Python API）独立部署和扩展，降低了耦合度。
    *   不同服务可以使用最适合自身业务逻辑的技术栈，避免技术栈锁定。
*   **服务水平扩展**：
    *   **Go 服务**：Hasher、Transporter 和 Log Processor 等 Go 语言编写的服务是无状态的，可以通过简单地增加实例数量来实现水平扩展，以应对高并发的消息处理量。
    *   **Python FastAPI**：Python API 服务也可以通过部署多个实例并结合负载均衡器来实现水平扩展。
    *   **Go Agent**：Agent 自然是分布式部署，通过增加 Agent 实例来覆盖更多目标机器。
*   **消息队列的伸缩性**：
    *   RabbitMQ 作为消息中间件，其本身支持集群模式和Sharding/Federation，可以根据消息吞吐量进行水平扩展。
*   **数据库扩展性**：
    *   PostgreSQL 数据库可以通过以下方式进行扩展：
        *   **读写分离**：通过搭建主从复制，将读请求分发到只读副本，提高读取性能。
        *   **数据分片 (Sharding)**：在数据量巨大时，可以考虑对表进行水平分片，将数据分布到不同的数据库实例上。
*   **AI/ML 模块的弹性**：
    *   AI/ML 训练和推理服务可以独立部署，并利用容器编排工具（如 Kubernetes）进行弹性伸缩，根据计算负载动态调整资源。
*   **配置的动态性**：
    *   集中式动态配置管理使得系统参数可以在不重启服务的情况下进行调整，这对于系统扩展和优化至关重要。

---



## 部署和运维建议

为了确保 SentinelSync 平台的顺利部署和高效运维，我们提供以下建议：

*   **容器化部署**：
    *   所有服务（Go Agents、Go Services、Python FastAPI、RabbitMQ、PostgreSQL）都应进行容器化封装，使用 Docker 镜像。
    *   这提供了环境一致性，简化了部署流程，并支持资源隔离。
*   **自动化部署与编排**：
    *   利用容器编排工具（如 Kubernetes、Docker Swarm）进行自动化部署、扩缩容、服务发现和健康检查。
    *   实现基础设施即代码（IaC），通过版本控制管理部署配置。
*   **持续集成/持续部署 (CI/CD)**：
    *   建立 CI/CD 流水线，自动化代码构建、测试、镜像打包和部署，提高开发效率和发布质量。
    *   支持灰度发布和蓝绿部署策略，降低新版本上线风险。
*   **监控与日志集中化**：
    *   部署 Prometheus/Grafana 或 ELK/Loki 等集中化监控和日志系统，全面掌握平台运行状态和业务指标。
    *   结合告警规则，实现异常自动通知。
*   **备份与恢复策略**：
    *   制定详细的数据库和关键配置的备份策略。
    *   定期进行备份恢复演练，确保在灾难发生时能够快速恢复服务。
*   **版本管理与升级**：
    *   明确 Agent 和 Control Plane 的版本兼容性策略。
    *   提供平滑的平台升级路径，支持组件的独立升级和回滚能力。
*   **安全性加固**：
    *   定期进行安全审计和漏洞扫描。
    *   遵循最小权限原则，限制对生产环境的访问。


## 术语表

*   **Agent (客户端)**：部署在目标机器上的轻量级程序，负责数据采集、任务执行和与控制平面通信。
*   **Control Plane (控制平面)**：SentinelSync 的核心部分，包括管理服务器（Python FastAPI）、消息队列（RabbitMQ）和数据库（PostgreSQL），负责统一管理、调度和协调各项任务。
*   **FastAPI**：一个现代、快速（高性能）的 Web 框架，用于构建 API，基于 Python 类型提示。
*   **fsnotify**：Go 语言中用于监控文件系统事件（如文件创建、修改、删除）的库，在 Agent 端用于实时文件监控。
*   **RabbitMQ**：一个开源的消息代理和队列服务器，用于实现分布式系统中的异步通信和解耦。
*   **PostgreSQL**：一个强大的开源对象关系型数据库系统，作为 SentinelSync 的核心数据存储，用于存储元数据、资产信息、配置、日志等。
*   **Web UI (User Interface)**：基于 Vue 3 + Vite 构建的前端界面，供用户进行交互、配置和查看数据。
*   **AI/ML Engine**：基于 Python 构建的 AI/机器学习模块，用于日志分析、性能预测和异常检测等智能运维功能。
*   **CI/CD (Continuous Integration/Continuous Deployment)**：持续集成/持续部署，一种软件开发实践，旨在通过自动化提高软件交付频率和可靠性。
*   **IaC (Infrastructure as Code)**：基础设施即代码，通过代码而非手动流程来管理和配置基础设施（如服务器、网络等）。
*   **RBAC (Role-Based Access Control)**：基于角色的访问控制，一种根据用户在组织中的角色来授权访问计算机或网络资源的策略。
*   **TLS/SSL (Transport Layer Security/Secure Sockets Layer)**：传输层安全协议，用于在计算机网络上提供安全通信。
*   **WebSocket**：一种网络通信协议，提供全双工通信通道，用于实现客户端和服务器之间的实时交互。

---

## 实施优先级建议

1. **阶段一**：资产管理 + 基础备份功能
   - 建立 Agent 与 Control Plane 的通信
   - 实现资产自动发现和心跳监控
   - 完成文件监控和备份基础流程

2. **阶段二**：集中日志 + 远程运维
   - 日志采集与查询
   - 远程命令下发执行
   - Web UI 基础功能

3. **阶段三**：AI 智能分析
   - 日志异常检测
   - 备份性能预测
   - 容量规划建议

4. **阶段四**：高级功能
   - 备份验证与恢复测试
   - 智能告警与自动化响应
   - 多租户与权限管理
