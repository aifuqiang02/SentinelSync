# SentinelSync 开发环境 Docker Compose 配置
# 包含完整的服务栈：基础设施、后端服务、前端和管理工具
# docker-compose --env-file .env.local up -d

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-sentinelsync}
      POSTGRES_USER: ${POSTGRES_USER:-sentinel}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    ports:
      - "${POSTGRES_EXTERNAL_PORT:-5433}:5433"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./sql:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sentinel} -d ${POSTGRES_DB:-sentinelsync} -W ${POSTGRES_PASSWORD:-changeme}"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # Redis 缓存服务 (开发环境专享)
  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_EXTERNAL_PORT:-6379}:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped

  # RabbitMQ 消息队列 (带管理界面)
  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-sentinel}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-changeme}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/}
    ports:
      - "${RABBITMQ_EXTERNAL_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # PgAdmin 数据库管理界面 (开发环境专享)
  pgadmin:
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@sentinel.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      - postgres
    restart: unless-stopped

  management-server:
    image: python:3.11-slim
    working_dir: /app
    ports:
      - "${MANAGEMENT_SERVER_PORT:-8000}:${MANAGEMENT_SERVER_PORT:-8000}"
    volumes:
      - "../../control_plane/management_server:/app"  # 挂载管理服务器代码目录
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-sentinel}:${POSTGRES_PASSWORD:-changeme}@postgres:5433/${POSTGRES_DB:-sentinelsync}
      - REDIS_URL=redis://redis:6379/0
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-sentinel}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672${RABBITMQ_VHOST:-/}
    # 确保依赖的服务已经准备就绪
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    command: sh -c "cd /app && pip install -r requirements.txt && uvicorn main:app --host ${APP_HOST:-0.0.0.0} --port ${MANAGEMENT_SERVER_PORT:-8000} --reload --log-level debug"
    # cd .\control_plane\management_server\
    # uvicorn main:app --host 0.0.0.0 --port 8000 --reload --log-level debug
    restart: unless-stopped
  # Go 哈希计算服务 (带源码挂载)
  # hasher:
  #   image: golang:1.20-alpine
  #   working_dir: /app
  #   depends_on:
  #     rabbitmq:
  #       condition: service_healthy
  #   environment:
  #     RABBITMQ_URL: amqp://${RABBITMQ_USER:-sentinel}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672${RABBITMQ_VHOST:-/}
  #     LOG_LEVEL: "debug"
  #   volumes:
  #     - ../../services/hasher:/app
  #   command: sh -c "cd /app && go run cmd/*.go"
  #   restart: unless-stopped

  # Go 数据传输服务 (带源码挂载)
  # transporter:
  #   image: golang:1.20-alpine
  #   working_dir: /app
  #   depends_on:
  #     rabbitmq:
  #       condition: service_healthy
  #   environment:
  #     RABBITMQ_URL: amqp://${RABBITMQ_USER:-sentinel}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672${RABBITMQ_VHOST:-/}
  #     LOG_LEVEL: "debug"
  #   volumes:
  #     - ../../services/transporter:/app
  #   command: sh -c "cd /app && go run cmd/*.go"
  #   restart: unless-stopped

  # Go 日志处理服务 (带源码挂载)
  # log-processor:
  #   image: golang:1.20-alpine
  #   working_dir: /app
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     rabbitmq:
  #       condition: service_healthy
  #   environment:
  #     DATABASE_URL: postgresql://${POSTGRES_USER:-sentinel}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-sentinelsync}
  #     RABBITMQ_URL: amqp://${RABBITMQ_USER:-sentinel}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672${RABBITMQ_VHOST:-/}
  #     LOG_LEVEL: "debug"
  #   volumes:
  #     - ../../services/log_processor:/app
  #   command: sh -c "cd /app && go run processor.go"
  #   restart: unless-stopped

  # Vue 3 前端界面 (带热重载)
  web-ui:
    image: node:22-alpine
    user: root:root
    working_dir: /app
    ports:
      - "${WEB_UI_PORT:-3000}:3000"
    environment:
      COREPACK_AUTO_YES: "1"      # 自动同意大多数提示
      COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"  # 禁用下载确认
      CHOKIDAR_USEPOLLING: true
    volumes:
      - "../../control_plane/web_ui:/app"
      - "web_ui_node_modules:/app/node_modules"
      - "pnpm-global-store:/root/.local/share/pnpm/store/v3"
    command: >
      sh -c "
        corepack enable &&
        if [ ! -d node_modules/.pnpm ]; then
          pnpm install --prefer-frozen-lockfile || pnpm install
        fi &&
        pnpm dev --host 0.0.0.0 --port 3000
      "
    tty: true
    restart: unless-stopped

# 数据卷定义
volumes:
  postgres_data:
  redis_data:
  pnpm-global-store:      # ← 加这行就行了！
  web_ui_node_modules: