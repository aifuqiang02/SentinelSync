# SentinelSync 开发环境 Docker Compose 配置
# 包含完整的服务栈：基础设施、后端服务、前端和管理工具

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-sentinelsync}
      POSTGRES_USER: ${POSTGRES_USER:-sentinel}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    ports:
      - "${POSTGRES_EXTERNAL_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sentinel} -d ${POSTGRES_DB:-sentinelsync}"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # Redis 缓存服务 (开发环境专享)
  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_EXTERNAL_PORT:-6379}:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped

  # RabbitMQ 消息队列 (带管理界面)
  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-sentinel}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-changeme}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/}
    ports:
      - "${RABBITMQ_EXTERNAL_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # PgAdmin 数据库管理界面 (开发环境专享)
  pgadmin:
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@sentinel.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      - postgres
    restart: unless-stopped

  # Python FastAPI 管理服务器 (带热重载)
  management-server:
    build:
      context: ./control_plane/management_server
    ports:
      - "${MANAGEMENT_SERVER_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-sentinel}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-sentinelsync}
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-sentinel}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672${RABBITMQ_VHOST:-/}
      APP_HOST: ${APP_HOST:-0.0.0.0}
      APP_PORT: ${APP_PORT:-8000}
      DEBUG: "true"
      LOG_LEVEL: "debug"
      SECRET_KEY: ${SECRET_KEY:-your-secret-key-here-change-me-in-production}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-["http://localhost:3000","http://127.0.0.1:3000","http://localhost:5173"]}
      AUTO_RELOAD: "true"
    volumes:
      # 挂载源代码用于热重载
      - ../control_plane/management_server:/app
      - /app/__pycache__
    command: >
      sh -c "pip install -r requirements.txt &&
             uvicorn main:app --host 0.0.0.0 --port 8000 --reload --log-level debug"
    restart: unless-stopped

  # Go 哈希计算服务 (带源码挂载)
  hasher:
    build:
      context: ./services/hasher
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-sentinel}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672${RABBITMQ_VHOST:-/}
      LOG_LEVEL: "debug"
    volumes:
      - ../services/hasher:/app
    restart: unless-stopped

  # Go 数据传输服务 (带源码挂载)
  transporter:
    build:
      context: ./services/transporter
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-sentinel}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672${RABBITMQ_VHOST:-/}
      LOG_LEVEL: "debug"
    volumes:
      - ../services/transporter:/app
    restart: unless-stopped

  # Go 日志处理服务 (带源码挂载)
  log-processor:
    build:
      context: ./services/log_processor
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-sentinel}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-sentinelsync}
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-sentinel}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672${RABBITMQ_VHOST:-/}
      LOG_LEVEL: "debug"
    volumes:
      - ../services/log_processor:/app
    restart: unless-stopped

  # Vue 3 前端界面 (带热重载)
  web-ui:
    build:
      context: ./control_plane/web_ui
    ports:
      - "${WEB_UI_PORT:-5173}:5173"
    depends_on:
      - management-server
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
      VITE_DEV_MODE: "true"
      VITE_LOG_LEVEL: "debug"
    volumes:
      # 挂载源代码用于热重载
      - ../control_plane/web_ui:/app
      - /app/node_modules
    command: >
      sh -c "npm install &&
             npm run dev -- --host 0.0.0.0 --port 5173"
    restart: unless-stopped

# 数据卷定义
volumes:
  postgres_data:
  redis_data: